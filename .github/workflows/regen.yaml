name: Regenerate Paws Website

on:
  schedule:
    # At 12:00, on day 10 of the month, every 4 months
    # Giving 10 days for paws regen to be approved
    - cron:  '0 12 10 */4 *'
  workflow_dispatch:
      inputs:
      text_to_print:
        description: 'Manual re-build'

jobs:
  setup:
    runs-on: ubuntu-latest
    name: update-dependencies

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev

      - name: Install Website Dependencies
        run: |
          install.packages(c('pkgdown', 'roxygen2', 'remotes', 'optparse'))
        shell: Rscript {0}

      - name: Update Paws Submodule
        run: |
          make update-deps

      - name: Create Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git checkout -b regen_paws_website
          
      - name: Clear down Website read for re-build
        run: |
          rm -fr docs

      - name: Create Commit Message
        run: |
          git add .
          git commit -m "Update dependencies"
          git push origin regen_paws_website

      - name: Install Paws Dependencies
        run: |
          remotes::install_deps('vendor/paws/paws.common', dependencies = TRUE)
          remotes::install_deps('vendor/paws/make.paws', dependencies = TRUE)
        shell: Rscript {0}

      - name: Install Paws Packages
        run: |
          remotes::install_local('vendor/paws/paws.common', force = TRUE)
          remotes::install_local('vendor/paws/make.paws', force = TRUE)
          make.paws::paws_install('vendor/paws/cran')
        shell: Rscript {0}

      - name: Regenerate Paws Website topics
        run: |
          make build-topics

      - name: cache vendor dependencies
        run: |
          zip -r vendor.zip vendor

      - uses: actions/upload-artifact@v3
        with:
          name: vendor-dependency
          path: |
            vendor.zip
            topics/

      - name: Clean Up
        run: |
          make clean-up
          
      - name: Git Commit Topics
        run: |
          git add docs
          git commit -m "Update Topics Index"
          git push origin regen_paws_website
          
  doc-build-prt1:
    needs: setup

    runs-on: ubuntu-latest
    name: regenerate-docs-paws-website-1

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev

      - name: Install Website Dependencies
        run: |
          install.packages(c('pkgdown', 'roxygen2', 'remotes', 'optparse'))
        shell: Rscript {0}

      - uses: actions/download-artifact@v3
        with:
          name: vendor-dependency
          path: .

      - name: unzip vendor dependencies
        run: |
          unzip vendor.zip -d temp

      - name: Install Paws Dependencies
        run: |
          remotes::install_deps('temp/vendor/paws/paws.common', dependencies = TRUE)
          remotes::install_deps('temp/vendor/paws/make.paws', dependencies = TRUE)
        shell: Rscript {0}

      - name: Install Paws Packages
        run: |
          remotes::install_local('temp/vendor/paws/paws.common', force = TRUE)
          remotes::install_local('temp/vendor/paws/make.paws', force = TRUE)
          make.paws::paws_install('temp/vendor/paws/cran')
        shell: Rscript {0}

      - name: Change Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin
          git switch regen_paws_website
          git pull

      - name: Regenerate Paws Website part 1
        run: |
          Rscript docs.R --docs --file topics/topics_prt1.txt

      - name: clean up
        run: |
          make clean-up
          
      - name: zip up documentation part
        run: |
          zip -r docs.zip docs/reference

      - uses: actions/upload-artifact@v3
        with:
          name: docs-prt1
          path: |
            docs.zip
        


  doc-build-prt2:
    needs: setup

    runs-on: ubuntu-latest
    name: regenerate-docs-paws-website-2

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev

      - name: Install Website Dependencies
        run: |
          install.packages(c('pkgdown', 'roxygen2', 'remotes', 'optparse'))
        shell: Rscript {0}

      - uses: actions/download-artifact@v3
        with:
          name: vendor-dependency
          path: .

      - name: unzip vendor dependencies
        run: |
          unzip vendor.zip -d temp

      - name: Install Paws Dependencies
        run: |
          remotes::install_deps('temp/vendor/paws/paws.common', dependencies = TRUE)
          remotes::install_deps('temp/vendor/paws/make.paws', dependencies = TRUE)
        shell: Rscript {0}

      - name: Install Paws Packages
        run: |
          remotes::install_local('temp/vendor/paws/paws.common', force = TRUE)
          remotes::install_local('temp/vendor/paws/make.paws', force = TRUE)
          make.paws::paws_install('temp/vendor/paws/cran')
        shell: Rscript {0}

      - name: Change Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin
          git switch regen_paws_website
          git pull

      - name: Regenerate Paws Website part 1
        run: |
          Rscript docs.R --docs --file topics/topics_prt2.txt

      - name: clean up
        run: |
          make clean-up

      - name: zip up documentation part
        run: |
          zip -r docs.zip docs/reference

      - uses: actions/upload-artifact@v3
        with:
          name: docs-prt2
          path: |
            docs.zip

  doc-build-prt3:
    needs: setup

    runs-on: ubuntu-latest
    name: regenerate-docs-paws-website-3

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev

      - name: Install Website Dependencies
        run: |
          install.packages(c('pkgdown', 'roxygen2', 'remotes', 'optparse'))
        shell: Rscript {0}

      - uses: actions/download-artifact@v3
        with:
          name: vendor-dependency
          path: .

      - name: unzip vendor dependencies
        run: |
          unzip vendor.zip -d temp

      - name: Install Paws Dependencies
        run: |
          remotes::install_deps('temp/vendor/paws/paws.common', dependencies = TRUE)
          remotes::install_deps('temp/vendor/paws/make.paws', dependencies = TRUE)
        shell: Rscript {0}

      - name: Install Paws Packages
        run: |
          remotes::install_local('temp/vendor/paws/paws.common', force = TRUE)
          remotes::install_local('temp/vendor/paws/make.paws', force = TRUE)
          make.paws::paws_install('temp/vendor/paws/cran')
        shell: Rscript {0}

      - name: Change Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin
          git switch regen_paws_website
          git pull

      - name: Regenerate Paws Website part 1
        run: |
          Rscript docs.R --docs --file topics/topics_prt3.txt

      - name: clean up
        run: |
          make clean-up

      - name: zip up documentation part
        run: |
          zip -r docs.zip docs/reference

      - uses: actions/upload-artifact@v3
        with:
          name: docs-prt3
          path: |
            docs.zip


  combine-docs:
    needs: [doc-build-prt1, doc-build-prt2, doc-build-prt3]

    runs-on: ubuntu-latest
    name: regenerate-docs-paws-website-3

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'
          
      - name: Change Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin
          git switch regen_paws_website
          git pull

      - uses: actions/download-artifact@v3
        with:
          name: docs-prt1
          path: .
          
      - name: process prt1
        run: |
          mkdir -p temp/temp1
          unzip docs.zip -d temp/temp1
          rm docs.zip
          
      - uses: actions/download-artifact@v3
        with:
          name: docs-prt2
          path: .
          
      - name: process prt2
        run: |
          mkdir -p temp/temp2
          unzip docs.zip -d temp/temp2
          rm docs.zip
          
      - uses: actions/download-artifact@v3
        with:
          name: docs-prt3
          path: .
          
      - name: process prt3
        run: |
          mkdir -p temp/temp3
          unzip docs.zip -d temp/temp3

      - name: combine-docs
        run: |
          Rscript docs.R --combine

      - name: clean up
        run: |
          make clean-up

      - name: Create Commit Message
        run: |
          git add .
          git commit -m "Regenerate Docs for Paws Website Version"
          git push origin regen_paws_website

  index:
    needs: combine-docs

    runs-on: ubuntu-latest
    name: regenerate-index-paws-website

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Install R
        uses: r-lib/actions/setup-r@v2

      - uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '2.17.1'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev
          sudo apt-get install -y libharfbuzz-dev libfribidi-dev
      - name: Install Website Dependencies
        run: |
          install.packages(c('pkgdown', 'roxygen2', 'remotes', 'optparse'))
        shell: Rscript {0}

      - name: Get Paws Submodule
        run: |
          make update-deps
      - name: Install Paws Dependencies
        run: |
          remotes::install_deps('vendor/paws/paws.common', dependencies = TRUE)
          remotes::install_deps('vendor/paws/make.paws', dependencies = TRUE)
        shell: Rscript {0}

      - name: Install Paws Packages
        run: |
          remotes::install_local('vendor/paws/paws.common', force = TRUE)
          remotes::install_local('vendor/paws/make.paws', force = TRUE)
          make.paws::paws_install('vendor/paws/cran')
        shell: Rscript {0}

      - name: Change Branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git fetch origin
          git switch regen_paws_website
          git pull

      - name: Regenerate Paws Website Index
        run: |
          make build-index

      - name: Get Paws SDK Version
        id: version
        run: |
          version=$(Rscript get_version.R)
          pr_body="Regenerate Paws SDK Website: ${version}"

      - name: Create Commit Message
        run: |
          git add .
          git commit -m "Regenerate Index for Paws Website Version"
          git push origin regen_paws_website

      - name: Create Github Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "Regenerate Paws" --body "${{ steps.version.outputs.pr_body }}"
